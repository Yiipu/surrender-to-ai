<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title data-i18n="title">Surrender to AI</title>
    <style>
        body {
            font-family: system-ui, "Microsoft YaHei";
            padding: 24px;
            background: #f7f7f7
        }

        .card {
            max-width: 700px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, .06);
            overflow: hidden
        }

        textarea {
            display: block;
            box-sizing: border-box;
            width: 100%;
            resize: vertical;
            height: 120px
        }

        input,
        button,
        textarea {
            font-size: 14px;
            padding: 8px;
            margin: 6px 0
        }

        select {
            position: relative;
            float: right;
        }
    </style>
</head>

<body>
    <div class="card">
        <select id="lang-switcher">
            <option value="en">English</option>
            <option value="zh">中文</option>
            <option value="ja">日本語</option>
        </select>

        <h1 data-i18n="heading">Sign Your Surrender</h1>
        <form id="surrenderForm">
            <label data-i18n="name_label">Your Name:</label>
            <input type="text" name="name" id="name" required><br />
            <label data-i18n="note_label">Postscript (optional): </label>
            <textarea id="note" name="note"></textarea>
            <input type="checkbox" id="agree" required>
            <label data-i18n="agree_label"> I understand this is a public
                record
                (irreversible, auditable)</label><br />
            <button type="submit" data-i18n="submit" id="surrender">Submit</button>
        </form>

        <div style="margin-top:12px">
            <pre id="pending" style="display:none" data-i18n="pending">Submitting...</pre>
            <a id="dlsig" style="display:none" data-i18n="dlsig">Download Your Signature</a>
            <a id="dlots" style="display:none" data-i18n="dlots">Download Your OTS</a>
        </div>

    </div>

    <script src="i18n.js"></script>
    <script>
        const dlots = document.getElementById('dlots');
        const dlsig = document.getElementById('dlsig');
        const pending = document.getElementById('pending');

        document.getElementById('surrenderForm').addEventListener('submit', async e => {
            e.preventDefault();
            const sign = {
                type: 'surrender-to-ai',
                name: document.getElementById('name').value.slice(0, 200).trim(),
                note: document.getElementById('note').value.slice(0, 2000).trim(),
                lang: document.getElementById('lang-switcher').value,
                timestamp: new Date().toISOString()
            };
            const content = JSON.stringify(sign, null, 2);
            const sha256 = crypto.createHash('sha256').update(content).digest('hex');
            const filename = `${sign.timestamp.replace(/[:.]/g, '-')}-${sha256.slice(0, 10)}.json`;
            const b64 = Base64.encode(content);

            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            dlsig.href = url;
            dlsig.download = filename;
            dlsig.style.display = 'block';

            try {
                const r = await fetch('/.netlify/functions/sign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ filename, sha256 })
                });
                const j = await r.json();
                if (!r.ok) throw new Error(j.message || 'submission failed');
                const otsBlob = new Blob([Base64.decode(j.ots_b64)], { type: 'application/octet-stream' });
                const otsUrl = URL.createObjectURL(otsBlob);
                dlots.href = otsUrl;
                dlots.download = filename + '.ots';
                dlots.style.display = 'inline';
                pending.style.display = 'block';
                pending.textContent = `OTS: ${j.ots_url}`;
            } catch (err) {
                pending.style.display = 'block';
                pending.textContent = err.message;
            }
        });
    </script>
</body>

</html>