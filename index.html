<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title data-i18n="title">Surrender to AI</title>
    <style>
        body {
            font-family: system-ui, "Microsoft YaHei";
            padding: 24px;
            background: #f7f7f7
        }

        .card {
            max-width: 700px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, .06);
            overflow: hidden
        }

        textarea {
            display: block;
            box-sizing: border-box;
            width: 100%;
            resize: vertical;
            height: 120px
        }

        input,
        button,
        textarea {
            font-size: 14px;
            padding: 8px;
            margin: 6px 0
        }

        select {
            position: relative;
            float: right;
        }
    </style>
</head>

<body>
    <div class="card">
        <select id="lang-switcher">
            <option value="en">English</option>
            <option value="zh">中文</option>
            <option value="ja">日本語</option>
        </select>

        <h1 data-i18n="heading">Sign Your Surrender</h1>
        <form id="surrenderForm">
            <label data-i18n="name_label">Your Name:</label>
            <input type="text" name="name" id="name" required><br />
            <label data-i18n="note_label">Postscript (optional): </label>
            <textarea id="note" name="note"></textarea>
            <input type="checkbox" id="agree" required>
            <label data-i18n="agree_label"> I understand this is a public
                record
                (irreversible, auditable)</label><br />
            <button type="submit" data-i18n="submit" id="surrender">Submit</button>
        </form>

        <div style="margin-top:12px">
            <a id="dlsig" style="display:none" data-i18n="dlsig">Download Your Signature</a>
            <p id="pending" style="display:none" data-i18n="pending">Submitting...</p>
            <a id="dlots" style="display:none" data-i18n="dlots">Download Your OTS</a>
        </div>

    </div>

    <script src="i18n.js"></script>
    <script>
        const dlots = document.getElementById('dlots');
        const dlsig = document.getElementById('dlsig');
        const pending = document.getElementById('pending');

        document.getElementById('surrenderForm').addEventListener('submit', async e => {
            e.preventDefault();
            const sign = {
                type: 'surrender-to-ai',
                name: document.getElementById('name').value.slice(0, 200).trim(),
                note: document.getElementById('note').value.slice(0, 2000).trim(),
                timestamp: new Date().toISOString()
            };
            const content = JSON.stringify(sign, null, 2);

            // 计算 SHA-256 哈希
            const sha256 = await computeSHA256(content);
            const filename = `${sign.timestamp.replace(/[:.]/g, '-')}-${sha256.slice(0, 10)}.json`;
            const b64 = btoa(content); // 使用 btoa 编码 Base64

            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            dlsig.href = url;
            dlsig.download = filename;
            dlsig.style.display = 'inline-block';

            pending.style.display = 'inline-block';
            try {
                const r = await fetch('/.netlify/functions/sign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, sha256 })
                });
                const j = await r.json();

                // 错误
                if (r.status === 400) {
                    pending.textContent = 'Submission failed: ' + j.message;
                    return;
                }

                // 成功或部分成功
                if (r.status === 200 || r.status === 202) {
                    let otsUrl;

                    if (r.status === 202) {
                        const asciiString = j.otsFile;
                        const byteArray = new Uint8Array(asciiString.split(',').map(num => parseInt(num, 10)));
                        const otsBlob = new Blob([byteArray], { type: 'application/octet-stream' });

                        otsUrl = URL.createObjectURL(otsBlob);
                    } else {
                        otsUrl = j.ots_url;
                    }

                    // 设置下载链接
                    dlots.href = otsUrl;
                    dlots.download = filename + '.ots';
                    dlots.style.display = 'inline-block';

                    // 更新提示信息
                    pending.textContent = r.status === 200
                        ? `OTS created and uploaded to ${j.ots_url}`
                        : 'OTS created and not uploaded, please download and upgrade it manually';

                    return;
                }

                throw new Error('Unexpected response from server');
            } catch (err) {
                pending.style.display = 'inline-block';
                pending.textContent = err.message;
            }
        });

        // 计算 SHA-256 哈希的函数
        async function computeSHA256(content) {
            const encoder = new TextEncoder();
            const data = encoder.encode(content);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = new Uint8Array(hashBuffer);
            return Array.from(hashArray).map(byte => byte.toString(16).padStart(2, '0')).join('');
        }
    </script>
</body>

</html>